function [Bout] = BoutRhythmSpectrogram(DirectoryName, FileList, FileType, PlotOption, ThreshMultiplier, MotifTemplate, ChooseBouts, StretchValues)

TimeNow = datestr(now, 'mmddyyHHMMSS');

% Open log file for results
if (ispc)
    LogFid = fopen(['C:\Documents and Settings\PlumPie\My Documents\RaghavData\BoutStats_',TimeNow,'.log'], 'w');
else
    LogFid = fopen(['/home/raghav/BoutStatistics/BoutStats_',TimeNow,'.log'], 'w');
end

% Write input parameters to Log file
fprintf(LogFid, 'DirectoryName: %s\n', DirectoryName);
fprintf(LogFid, 'FileList: %s\n', FileList);
fprintf(LogFid, 'FileType: %s\n', FileType);
fprintf(LogFid, 'PlotOption: %s\n', PlotOption);
fprintf(LogFid, 'FileType: %s\n', FileType);
fprintf(LogFid, 'Threshold multiplier is %i\n', ThreshMultiplier);
fprintf(LogFid, 'Choose bouts: %s\n', ChooseBouts);
fprintf(LogFid, 'Stretch values are ');
for i = 1:length(StretchValues),
    fprintf(LogFid, '%i,', StretchValues(i));
end
fprintf(LogFid, '\n\n\n');

min_int = 0.005;
min_dur = 0.010;
sm_win = 0.008;

FFTWinSize = sm_win; % in sec
FFTWinOverlap = 0.5;

if ispc
    if (DirectoryName(end) ~= '\')
        DirectoryName(end + 1) = '\';
    end 
else
    if (DirectoryName(end) ~= '/')
        DirectoryName(end + 1) = '/';
    end
end

cd(DirectoryName);

DiscardedBouts = 0;

x = 1:1:size(MotifTemplate, 2);

BoutIndex = 1;

Fid = fopen(FileList, 'r');
SongFile = fgetl(Fid);

while (ischar(SongFile(1)))
    Slash = find((SongFile == '/') | (SongFile == '\'));
    if (~isempty(Slash))
        SongFile = SongFile(Slash(end)+1:end);
    end
    disp(SongFile);
    fprintf(LogFid, '\nSongfile name: %s\n', SongFile);
    try
        if (strfind(FileType, 'okrank'))
            [Song, Fs] = ReadOKrankData(DirectoryName, SongFile, 1);
        else
            if (strfind(FileType, 'wav'))
                [Song, Fs] = wavread(SongFile);
            else
                if (strfind(FileType, 'obs'))
                    channel_string = strcat('obs',num2str(0),'r');
                    [Song, Fs] = soundin_copy(DirectoryName, SongFile, channel_string);
    
                    % Convert to uV - 5V on the data acquisition is 32768
                    Song = Song * 5/32768;
                end
            end
        end
    catch
        continue;
    end
    if (isempty(Song))
        continue;
    end
   % [m_spec_deriv , m_AM, m_FM ,m_Entropy , m_amplitude , m_Freq, m_PitchGoodness , m_Pitch , Pitch_chose , Pitch_weight ]=deriv(Song, Fs);
    
    WinSize = round(FFTWinSize * Fs);
    WinOverlap = round(FFTWinOverlap * WinSize);

    [S, F, T, P] = spectrogram(Song, hamming(WinSize), WinOverlap, WinSize, Fs);
    
    Freq1 = find((F >= 860) & (F <= 8600));
    Power = log10(sum(S(Freq1,:).*conj(S(Freq1,:))));
    S = log10(abs(S(Freq1,:)));
    
    Obj = gmdistribution.fit(Power, 2, 'Start', 'randSample', 'Replicates', 10);
    [SoundMSD(1), Index] = max(Obj.mu);
    SoundMSD(2) = Obj.Sigma(Index);
    [NoiseMSD(1), Index] = min(Obj.mu);
    NoiseMSD(2) = Obj.Sigma(Index);

    Threshold = SoundMSD(1) - ThreshMultiplier*SoundMSD(2);
    disp(['Threshold is ', num2str(Threshold)]);
    
    fprintf(LogFid, 'Noise mean and std are %g and %g\n', NoiseMSD(1), NoiseMSD(2));
    fprintf(LogFid, 'Sound mean and std are %g and %g\n', SoundMSD(1), SoundMSD(2));
    fprintf(LogFid, 'Threshold is %g', Threshold);
    
    % Power = 10*log10(sum(P));
    % ThreshCrossing = Power > Threshold;
    [onsets, offsets] = segment_song(Power, (1/(T(2) - T(1))), min_int*1000, min_dur*1000, Threshold, NoiseMSD, ThreshMultiplier);
    onsets = onsets/1000;
    offsets = offsets/1000;

    if (size(onsets,1) < size(onsets, 2))
        onsets = onsets';
    end
    if (size(offsets,1) < size(offsets, 2))
        offsets = offsets';
    end
    
    if (strfind(ChooseBouts, 'no'))

        Temp = (onsets(2:end) - offsets(1:end-1));
        if (onsets(1) > 0.5)
            BoutOnsets = [onsets(1); onsets(find(Temp > 1) + 1)];
            if (offsets(end) > (T(end) - 0.5))
                BoutOffsets = [offsets(Temp > 1); (offsets(end) - 0.5)];
            else
                BoutOffsets = [offsets(Temp > 1); offsets(end)];
            end
        else
            BoutOnsets = [(onsets(1) + 0.5); onsets(find(Temp > 1) + 1)];
            if (offsets(end) > (T(end) - 0.5))
                BoutOffsets = [offsets(Temp > 1); (offsets(end) - 0.5)];
            else
                BoutOffsets = [offsets(Temp > 1); offsets(end)];
            end
        end
        BoutOnsets = BoutOnsets - 0.5;
        BoutOffsets = BoutOffsets + 0.5;

        Bouts = [BoutOnsets BoutOffsets];
        if (~isempty(Bouts))
            DiscardedBouts = DiscardedBouts + length(find((Bouts(:,2) - Bouts(:,1)) <= 2));
            Bouts = Bouts((Bouts(:,2) - Bouts(:,1)) > 2,:);

  %          BoutRemoval = [];
  %          for BoutNo = 1:size(Bouts,1),
  %              OnsetIndices = find((onsets >= Bouts(BoutNo, 1)) & (onsets <= Bouts(BoutNo, 2)));
  %              ISIs = onsets(OnsetIndices(2:end)) - offsets(OnsetIndices(1:end-1));
  %              if ((length(find(ISIs > 0.4))/length(ISIs)) >= 0.1)
  %                  BoutRemoval = [BoutRemoval; BoutNo];
  %              end
  %          end
  %          DiscardedBouts = DiscardedBouts + length(BoutRemoval);
  %          if (length(BoutRemoval) > 0)
  %              Bouts(BoutRemoval,:) = [];
  %          end
            %Time = linspace(T(1), T(end), length(m_Entropy));
            for BoutNo = 1:size(Bouts,1),
                fprintf(LogFid, 'Bout #%i\n', BoutNo);
                fprintf('B%i ', BoutNo);
                Bout.BoutAmplitudes{BoutIndex} = Power((T >= Bouts(BoutNo,1)) & (T <= Bouts(BoutNo, 2)));
             %   Bout.BoutPG{BoutIndex} = m_PitchGoodness(find((Time >= Bouts(BoutNo,1)) & (Time <= Bouts(BoutNo, 2))));
              %  Bout.BoutFM{BoutIndex} = m_FM(find((Time >= Bouts(BoutNo,1)) & (Time <= Bouts(BoutNo, 2))));
              %  Bout.BoutEntropy{BoutIndex} = m_Entropy(find((Time >= Bouts(BoutNo,1)) & (Time <= Bouts(BoutNo, 2))));
                Bout.BoutAmplitudeFs{BoutIndex} = 1/(T(2) - T(1));
             %   Bout.BoutPGFs{BoutIndex} = 1/(Time(2) - Time(1));
                Indices = (find((T >= Bouts(BoutNo,1)) & (T <= Bouts(BoutNo, 2))));

                WarpIndex = 1;
                % Matches = [];
                for i = [StretchValues],
                    xx = linspace(x(1), x(end), (size(MotifTemplate,2) * (1 + i/100)));
                    clear WMotif;
                    WMotif = zeros(size(MotifTemplate,1), length(xx));
                    for j = 1:size(MotifTemplate, 1);
                        WMotif(j,:) = spline(x, MotifTemplate(j,:), xx);
                    end
                    TempS = S(:,Indices);
                    
                    WinMean = zeros((size(TempS,2) - size(WMotif,2) + 1), 1);
                    WinSTD = zeros((size(TempS,2) - size(WMotif,2) + 1), 1);
                    
                    for ColNo = 1:(size(TempS,2) - size(WMotif, 2) + 1),
                        StartIndex = ((ColNo - 1)*size(WMotif,1)) + 1;
                        WinIndices = StartIndex:1:(StartIndex + size(WMotif,1)*size(WMotif,2) - 1);
                        WinMean(ColNo) = mean(TempS(WinIndices));
                        WinSTD(ColNo) = std(TempS(WinIndices));
%                        Data = (Data - mean(mean(Data)))./std(reshape(Data, 1, (size(Data,1) * size(Data,2))));
 %                       Match1(ColNo,1) = 1/sum(sum((abs(Data - WMotif))));
                    end
                    [Match] = CalTemplateMatch(WMotif, TempS, WinMean, WinSTD);
                    fprintf(LogFid, '%g\n', max(Match));
                    Bout.BoutSeqMatch{BoutIndex}{WarpIndex} = Match;
                    WarpIndex = WarpIndex + 1;
                    fprintf('>');
                end
                Bout.T{BoutIndex} = T(Indices);
                BoutIndex = BoutIndex + 1;
                fprintf('\t');
            end
        end
    else
        PlotSpectrogram(DirectoryName, SongFile, FileType);
        zoom xon;
        Flag = 1;
        Bouts = [];
        while(Flag)
            TempMsgBox = msgbox('Zoom into the desired region and then close this box when ready');
            waitfor(TempMsgBox);
            disp('Choose bout onset and offset');
            [x1] = ginput(2);
            Bouts(end+1,:) = [x1(1) x1(2)];
            YesNo = inputdlg('Do you want to choose more bouts? (y for yes and n for no)');
            if (isempty(strfind(YesNo{1}, 'y')))
                Flag = 0;
            end
        end
        for BoutNo = 1:size(Bouts,1),
            fprintf(LogFid, 'Bout #%i\n', BoutNo);
            fprintf('B%i ', BoutNo);
            Bout.BoutAmplitudes{BoutIndex} = Power((T >= Bouts(BoutNo,1)) & (T <= Bouts(BoutNo, 2)));
         %   Bout.BoutPG{BoutIndex} = m_PitchGoodness(find((Time >= Bouts(BoutNo,1)) & (Time <= Bouts(BoutNo, 2))));
          %  Bout.BoutFM{BoutIndex} = m_FM(find((Time >= Bouts(BoutNo,1)) & (Time <= Bouts(BoutNo, 2))));
          %  Bout.BoutEntropy{BoutIndex} = m_Entropy(find((Time >= Bouts(BoutNo,1)) & (Time <= Bouts(BoutNo, 2))));
            Bout.BoutAmplitudeFs{BoutIndex} = 1/(T(2) - T(1));
         %   Bout.BoutPGFs{BoutIndex} = 1/(Time(2) - Time(1));
            Indices = (find((T >= Bouts(BoutNo,1)) & (T <= Bouts(BoutNo, 2))));

            WarpIndex = 1;
            % Matches = [];
            for i = [StretchValues],
                xx = linspace(x(1), x(end), (size(MotifTemplate,2) * (1 + i/100)));
                clear WMotif;
                WMotif = zeros(size(MotifTemplate,1), length(xx));
                for j = 1:size(MotifTemplate, 1);
                    WMotif(j,:) = spline(x, MotifTemplate(j,:), xx);
                end
                TempS = S(:,Indices);

                WinMean = zeros((size(TempS,2) - size(WMotif,2) + 1), 1);
                WinSTD = zeros((size(TempS,2) - size(WMotif,2) + 1), 1);

                for ColNo = 1:(size(TempS,2) - size(WMotif, 2) + 1),
                    StartIndex = ((ColNo - 1)*size(WMotif,1)) + 1;
                    WinIndices = StartIndex:1:(StartIndex + size(WMotif,1)*size(WMotif,2) - 1);
                    WinMean(ColNo) = mean(TempS(WinIndices));
                    WinSTD(ColNo) = std(TempS(WinIndices));
%                        Data = (Data - mean(mean(Data)))./std(reshape(Data, 1, (size(Data,1) * size(Data,2))));
%                       Match1(ColNo,1) = 1/sum(sum((abs(Data - WMotif))));
                end
                [Match] = CalTemplateMatch(WMotif, TempS, WinMean, WinSTD);
                fprintf(LogFid, '%g\n', max(Match));
                Bout.BoutSeqMatch{BoutIndex}{WarpIndex} = Match;
                WarpIndex = WarpIndex + 1;
                fprintf('>');
            end
            Bout.T{BoutIndex} = T(Indices);
            BoutIndex = BoutIndex + 1;
            fprintf('\t');
        end
    end
    
    if (strfind(PlotOption, 'on'))
        PlotSpectrogram(DirectoryName, SongFile, FileType);
        hold on;
        plot(T, (Power + (abs(min(Power))))*100);
        for j = 1:length(onsets),
            plot([onsets(j) onsets(j) offsets(j) offsets(j)], [0 8000 8000 0],'r');
        end
        if (~isempty(Bouts))
            for j = 1:size(Bouts,1),
                plot([Bouts(j,1) Bouts(j,2)], [7500 7500],'b', 'LineWidth', 2);
                %plot(Bout.T{BoutIndex - j}(1:length(Bout.BoutSeqMatch{BoutIndex - j})), (Bout.BoutSeqMatch{BoutIndex-j}/max(Bout.BoutSeqMatch{BoutIndex-j})) *8000, 'r', 'LineWidth', 2);
            end
        end
        plot([T(1) T(end)], [((NoiseMSD(1) + ThreshMultiplier*NoiseMSD(2)) + (abs(min(Power))))*100 ((NoiseMSD(1) + ThreshMultiplier*NoiseMSD(2)) + (abs(min(Power))))*100], 'g', 'LineWidth', 2);
        plot([T(1) T(end)], [(Threshold + (abs(min(Power))))*100 (Threshold + (abs(min(Power))))*100], 'c', 'LineWidth', 2);        
        zoom xon;
        uiwait(gcf);
    else
        fprintf('\n');
    end
    
    clear onsets offsets Bouts BoutOnsets BoutOffsets Temp;
    SongFile = fgetl(Fid);
end
disp(['Discarded ', num2str(DiscardedBouts), ' bouts out of a total of ', num2str(BoutIndex - 1), ' bouts']);
fclose(LogFid);
